# Веб-сервис "Ассистент по языку запросов 1С:Предприятие 8"

## Описание

Программа разработана для помощи в создании запросов на платформе 1С:Предприятие 8.

Решаемые задачи:
- Интеграция, позволяющая пользователям работать из привычного интерфейса 1С:Предприятие 8.
- Предоставление ИИ-агенту контекста для создания текста запроса: список и описание таблиц информационной базы.
- Уведомление ИИ-агента о результатах проверки синтаксиса запроса.

Интеллектуальным агентом в текущей версии выступает модель **GigaChat**.
 
Доступно три варианта работы:
- **Веб-сервис**. Подразумевается интеграция с внешней обработкой "Консоль запросов" или любым подобным инструментом;
- **Работа в консоли**. Работа выполняется в командной строке. Режим удобен для тестирования и отладки;
- **Загрузка метаданных**. Производится загрузка описания таблиц информационной базы в базу данных веб-сервиса.
   
Каждый из вариантов может быть запущен в ***режиме отладки*** с выводом отладочной информации в файл лога.

## Использование

### Веб-сервис

Для запуска **веб-сервиса** используйте параметр *start*: ```amd64/python main.py start```

**Веб-сервис** предоставляет следующий интерфейс:
- *Проверка запуска веб-сервиса*. Необходимо отправить GET-запрос по адресу веб-сервиса, например набрать в браузере: ```localhost:8000```.
Работающий **веб-сервис** вернет страницу с надписью ```SQL-assistant works```;
- *Создание текста запроса*. **Веб-сервис** ожидает описание задачи в формате JSON в теле POST запроса: ```{"prompt": "Описание задачи"}```.
В ответ вернется строка JSON вида: ```{"response": "Текст запроса"}```. Кодировка текста: ```UTF-8```.

### Работа в консоли

Запуск **работы в консоли** выполняется из ***режима отладки*** (см. далее).
Данный вариант работы позволяет ставить задачи на создание текста запроса в текстовом диалоге в формате "вопрос-ответ".

### Загрузка метаданных

Для ***загрузки метаданных*** выполните запуск с параметром *load_md*: ```amd64/python main.py load_md```.
Программа загрузит описание таблиц информационной базы из файла метаданных в базу данных **веб-сервиса**.

Формат файла метаданных достаточно свободный и определяется способностью модели работать со структурированной информацией.
Обязательным является только свойство *ИмяОбъекта* в описании каждой таблицы.
Примеры файла метаданных *metadata1.json* и внешней обработки для его формирования *dump_metadata.epf* включены в репозиторий.

### Режим отладки

Для работы в ***режиме отладки*** программу необходимо запустить без параметров: ```amd64/python main.py```.

Из ***режима отладки*** доступен запуск всех вариантов работы.
В данном режиме в файл лога выводится информация, которой обмениваются агенты **веб-сервиса**.

## Установка

Порядок установки:
1. Создайте новый каталог **веб-сервиса**;
2. Скачайте репозиторий программы, для этого:
	- Если у вас установлен Git:
		- В командной строке перейдите в каталог **веб-сервиса**: ```cd <путь к папке веб-сервиса>```;
		- Выполните команду клонирования репозитория: ```git clone https://github.com/sskondakov/RosNOU_Pr3.git```
	- Если Git не установлен:
		- На странице https://github.com/sskondakov/RosNOU_Pr3 в меню списка репозитория выберите команду *Code->Download ZIP*
		- Распакуйте скачанный архив в каталог **веб-сервиса**
3. В командной строке перейдите в каталог **веб-сервиса**: ```cd <путь к папке веб-сервиса>```;
4. Выполните команду: ```amd64/python install.py```
5. В случае успешной установки вы должны увидеть сообщение: ```Программа успешно установлена.```
6. Укажите ключ авторизации **GigaChat** в файле *gigakeys.ini*.

Внимание: работа **веб-сервиса** может блокироваться **брандмауэром** вашего компьютера, при необходимости настройте (см. в документации **брандмауэра**):
	- доступ к **веб-сервису** из **1С:Предприятие 8**;
	- доступ **веб-сервиса** к **GigaChat**;
	- доступ **веб-сервиса** к сервису проверки запросов **1С:Предприятие 8**.

## Тестирование

Для первоначального тестирования достаточно произвести установку **веб-сервиса** и указать ключ авторизации **GigaChat**.

### Тестирование веб-сервиса

Порядок тестирования:
1. В командной строке перейдите в каталог **веб-сервиса**: ```cd <путь к папке веб-сервиса>```;
2. Запустите **веб-сервис**: ```amd64/python main.py start```;
3. Проверьте успешность запуска, откройте браузер и наберите: ```localhost:8000```. Вы должны увидеть страницу с надписью ```SQL-assistant works```;
4. Проверьте интерфейс **веб-сервиса** по созданию запросов:
	- Если установлена платформа **1С:Предприятие 8**, воспользуйтесь внешней обработкой *check_assistant.epf* (см. в документации **1С:Предприятие 8**);
	- Если платформа **1С:Предприятие 8** не установлена, используйте скрипт *check_assistant.py*:
		- Откройте новое окно командной строки (окно с **веб-сервисом** должно оставаться открытым);
		- Перейдите в каталог **веб-сервиса**: ```cd <путь к папке веб-сервиса>```;
		- Запустите скрипт: ```amd64/python check_assistant.py```;
		- Введите описание задачи, например: *Продажи за неделю с отбором по контрагенту*;
		- Ответом должен быть текст запроса на языке платформы **1С:Предприятие 8**.
  
### Тестирование в консоли

Порядок тестирования:
1. В командной строке перейдите в каталог **веб-сервиса**: ```cd <путь к папке веб-сервиса>```;
2. Запустите ***режим отладки***: ```amd64/python main.py```;
3. Выберите вариант **Работа в консоли**;
4. Введите описание задачи, например: *Продажи за неделю с отбором по контрагенту*;
5. Ответом должен быть текст запроса на языке платформа 1С:Предприятие 8.

## Настройка

Для боевого применения необходимо выполнить детальную настройку **веб-сервиса** и его окружения.

Настройка параметров **веб-сервиса** выполняется в конфигурационных файлах:
1. *gigakeys.ini*:
	- секция ***GIGACHAT***
		- **authorization_key** - ключ авторизации **GigaChat** (см. в документации **сервиса**);
		- **session_id** - идентификатор сессии **GigaChat** (см. в документации **сервиса**);
2. *config.ini*:
	- секция ***MAIN***:
		- **metadata_db_name** - имя файла базы данных **веб-сервиса**;
		- **metadata_file_name** - файл метаданных с описанием таблиц информационной базы;
		- **port** - номер порта **веб-сервиса**;
	- секция ***GIGACHAT***:
		- **max_context_length** - размер контекста **GigaChat** (см. в документации **сервиса**);
		- **model** - используемая модель **GigaChat** (см. в документации **сервиса**);
	- секция ***CHECK_QUERY***:
		- url - путь к веб-сервису проверки запросов **1С:Предприятие 8**
		
Для формирования файла метаданных используйте внешнюю обработку *dump_metadata.epf* (см. в документации **1С:Предприятие 8**).

Для организации веб-сервису проверки запросов используйте расширение *check_query.cfe* (см. в документации **1С:Предприятие 8**).